!function(a){a.fn.snapPuzzle=function(b){function c(b){var c="sp_"+(new Date).getTime(),e=b.wrap('<span class="snappuzzle-wrap"/>').closest("span"),f=b.attr("src"),g=b.width()/d.columns,h=b.height()/d.rows,i=a(d.pile).addClass("snappuzzle-pile"),j=i.width()-g,k=i.height()-h;d.puzzle_class=c,b.data("options",d);for(var l=0;l<d.rows;l++)for(var m=0;m<d.columns;m++)a('<div class="snappuzzle-piece '+c+'"/>').data("pos",l+"_"+m).css({width:g,height:h,position:"absolute",left:Math.floor(Math.random()*(j+1)),top:Math.floor(Math.random()*(k+1)),zIndex:Math.floor(10*Math.random()+1),backgroundImage:"url("+f+")",backgroundPosition:-m*g+"px "+-l*h+"px",backgroundSize:b.width()}).draggable({start:function(b,c){a(this).removeData("slot")},stack:".snappuzzle-piece",containment:d.containment}).appendTo(i).data("lastSlot",i),a('<div class="snappuzzle-slot '+c+'"/>').data("pos",l+"_"+m).css({width:g,height:h,left:m*g,top:l*h}).appendTo(e).droppable({accept:"."+c,hoverClass:"snappuzzle-slot-hover",drop:function(e,f){var g=a(this).data("pos");return a(".snappuzzle-piece."+c).each(function(){a(this).data("slot")==g&&(g=!1)}),!!g&&(f.draggable.data("lastSlot",a(this)).data("slot",g),f.draggable.position({of:a(this),my:"left top",at:"left top"}),void(f.draggable.data("pos")==g&&(f.draggable.addClass("correct"),a(this).droppable("disable").css("opacity",1).fadeOut(1e3),f.draggable.css({opacity:0,cursor:"default"}).draggable("disable"),a(".snappuzzle-piece.correct."+c).length==d.rows*d.columns&&d.onComplete(b))))}})}var d=a.extend({pile:"",containment:"document",rows:5,columns:5,onComplete:function(){}},b);return"string"==typeof b?(this.each(function(){var c=a(this),d=c.data("options"),e=c.width()/d.columns,f=c.height()/d.rows,g=a(d.pile),h=g.width()-e,i=g.height()-f,j=c.closest("span").offset(),k=g.offset();"destroy"==b?(a("."+d.puzzle_class).remove(),c.unwrap().removeData("options"),g.removeClass("snappuzzle-pile")):"refresh"==b&&(a(".snappuzzle-slot."+d.puzzle_class).each(function(){var b=a(this).data("pos").split("_"),c=b[0],d=b[1];a(this).css({width:e,height:f,left:d*e,top:c*f})}),a(".snappuzzle-piece."+d.puzzle_class).each(function(){if(a(this).data("slot")){var b=a(this).data("slot").split("_"),d=b[0],g=b[1],b=a(this).data("pos").split("_"),l=b[0],m=b[1];a(this).css({width:e,height:f,left:g*e+j.left-k.left,top:d*f+j.top-k.top,backgroundPosition:-m*e+"px "+-l*f+"px",backgroundSize:c.width()})}else{var b=a(this).data("pos").split("_"),n=b[0],o=b[1];a(this).css({width:e,height:f,left:Math.floor(Math.random()*(h+1)),top:Math.floor(Math.random()*(i+1)),backgroundPosition:-o*e+"px "+-n*f+"px",backgroundSize:c.width()})}}))}),this):this.each(function(){this.complete?c(a(this)):a(this).load(function(){c(a(this))})})}}(jQuery);